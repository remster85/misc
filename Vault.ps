# Vault Configuration
$VAULT_ADDR = "http://your-vault-server:8200"   # Replace with your Vault server URL
$VAULT_TOKEN = "your-vault-token"               # Replace with your Vault token
$NAMESPACE = "xyz"                              # Namespace to query
$MOUNT_PATH = "secret"                          # KV v2 mount path

# Set Vault Environment Variables
$env:VAULT_ADDR = $VAULT_ADDR
$env:VAULT_TOKEN = $VAULT_TOKEN
$env:VAULT_NAMESPACE = $NAMESPACE  # Set namespace for multi-tenancy support

function Get-VaultSecretsRecursive {
    param (
        [string]$path = ""
    )

    # Vault KV v2 API to list secrets
    $fullPath = "$MOUNT_PATH/metadata/$path".Trim("/")
    $response = vault kv list -format=json $fullPath 2>$null | ConvertFrom-Json

    if ($null -eq $response) {
        return @()
    }

    $secrets = @()
    foreach ($key in $response) {
        if ($key -match "/$") {
            # If the key ends with "/", it's a folder, recurse into it
            $secrets += Get-VaultSecretsRecursive -path "$path$key"
        } else {
            $secrets += "$path$key"
        }
    }

    return $secrets
}

# Get all secrets recursively
$secrets = Get-VaultSecretsRecursive

# Output the list of secrets
Write-Host "Secrets under namespace '$NAMESPACE' in '$MOUNT_PATH':"
$secrets | ForEach-Object { Write-Host "- $_" }
