<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Table Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
            cursor: pointer;
        }
        #summary {
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2>Compare Table Results</h2>

    <input type="file" id="csvFile" accept=".csv">
    
    <div>
        <label for="filter">Filter Results:</label>
        <select id="filter">
            <option value="all">Any Difference</option>
            <option value="nbi_only">Only NBI Difference</option>
            <option value="rates_resolved">Only Rates Resolved</option>
            <option value="rates_changed">Only Rates Changed</option>
        </select>
    </div>

    <p id="summary">Matches: 0 | Total NBI Change: 0</p>

    <table id="resultTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Ref ID</th>
                <th onclick="sortTable(1)">Rate Level Used Before</th>
                <th onclick="sortTable(2)">Rate Level Used After</th>
                <th onclick="sortTable(3)">NBI Before</th>
                <th onclick="sortTable(4)">NBI After</th>
                <th onclick="sortTable(5)">Fields in Difference</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('csvFile').addEventListener('change', handleFile);
        document.getElementById('filter').addEventListener('change', filterTable);

        let tableData = [];  // Store parsed CSV data

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const delimiter = csvText.includes(";") ? ";" : ","; // Detect delimiter
            const lines = csvText.split("\n").map(line => line.trim()).filter(line => line);
            if (lines.length < 2) return;

            tableData = lines.slice(1).map(line => line.split(delimiter).map(cell => cell.trim()));

            displayTable(tableData);
        }

        function displayTable(data) {
            const tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";

            data.forEach(row => {
                if (row.length < 6) return; // Ensure all columns exist

                const tr = document.createElement("tr");
                row.forEach(cell => {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            filterTable();
        }

        function filterTable() {
            const filterValue = document.getElementById('filter').value;
            const tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";

            let filteredData = tableData.filter(row => {
                if (row.length < 6) return false; // Ensure valid row

                const rateBefore = row[1].trim();
                const rateAfter = row[2].trim();
                const nbiBefore = parseFloat(row[3].trim());
                const nbiAfter = parseFloat(row[4].trim());

                const isNbiDifferent = nbiBefore !== nbiAfter;
                const isRateResolved = rateBefore === "RATE_MISSING" && rateAfter !== "RATE_MISSING";
                const isRateChanged = rateBefore !== "RATE_MISSING" && rateBefore !== rateAfter;

                if (filterValue === "all" && (isNbiDifferent || isRateResolved || isRateChanged)) return true;
                if (filterValue === "nbi_only" && isNbiDifferent) return true;
                if (filterValue === "rates_resolved" && isRateResolved) return true;
                if (filterValue === "rates_changed" && isRateChanged) return true;

                return false;
            });

            filteredData.forEach(row => {
                const tr = document.createElement("tr");
                row.forEach(cell => {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            updateSummary(filteredData);
        }

        function updateSummary(data) {
            const totalMatches = data.length;
            const totalNbiChange = data.reduce((sum, row) => sum + (parseFloat(row[4]) - parseFloat(row[3])), 0);

            document.getElementById("summary").textContent = `Matches: ${totalMatches} | Total NBI Change: ${totalNbiChange}`;
        }

        function sortTable(columnIndex) {
            const tbody = document.querySelector("#resultTable tbody");
            let rows = Array.from(tbody.rows);

            rows.sort((rowA, rowB) => {
                let cellA = rowA.cells[columnIndex].textContent.trim();
                let cellB = rowB.cells[columnIndex].textContent.trim();

                if (!isNaN(cellA) && !isNaN(cellB)) {
                    return Number(cellB) - Number(cellA);
                }
                return cellA.localeCompare(cellB);
            });

            tbody.innerHTML = "";
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>

</body>
</html>
